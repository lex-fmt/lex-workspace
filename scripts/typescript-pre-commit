#!/bin/bash
#
# Pre-commit hook for TypeScript repos (lexed, vscode)
# Runs linting, type checking, building, and tests
#
# Install: Copy to .husky/pre-commit
# Manual:  ./scripts/typescript-pre-commit (from repo root)

set -e

REPO_NAME=$(basename "$(pwd)")

echo "Running pre-commit checks for $REPO_NAME..."

# Get available scripts from package.json
has_script() {
    npm pkg get scripts."$1" 2>/dev/null | grep -qv '^{}$'
}

# 1. Run lint-staged (always)
echo ""
echo "Running lint-staged..."
npx lint-staged
echo "Lint-staged OK"

# 2. Type check (if available)
if has_script "typecheck"; then
    echo ""
    echo "Running type check..."
    npm run typecheck
    echo "Type check OK"
fi

# 3. Build
echo ""
echo "Building..."
npm run build
echo "Build OK"

# 4. Run tests
echo ""
echo "Running tests..."

# lexed: has test:unit and test:e2e:built
if has_script "test:unit"; then
    echo "Running unit tests..."
    npm run test:unit -- --run
    echo "Unit tests OK"
fi

if has_script "test:e2e:built"; then
    echo "Running e2e tests..."
    npm run test:e2e:built
    echo "E2E tests OK"
# vscode: has single test command
elif has_script "test"; then
    npm run test
    echo "Tests OK"
fi

echo ""
echo "All pre-commit checks passed!"
